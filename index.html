<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>üé∏ Chord Viewer ¬∑ ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏û‡∏•‡∏á</title>
  <style>
    /* ---------- CSS Variables : Light & Dark theme ---------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      transition: background-color 0.2s ease, color 0.2s, border-color 0.2s;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* Light mode (default) */
    :root {
      --bg-primary: #f9f7f5;    /* ‡∏Ñ‡∏£‡∏µ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --bg-side: #f2f0ed;
      --text-primary: #1e1e2a;
      --text-secondary: #4a4a5a;
      --accent-light: #d4e6f1;   /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
      --accent-soft: #aaccdd;
      --border: #e2e0dd;
      --shadow: rgba(0,0,0,0.04) 0 4px 12px;
      --sticky-bg: rgba(255, 255, 255, 0.9);
      --btn-hover: #eae6e0;
      --code-bg: #f1f3f4;
    }

    body.dark {
      --bg-primary: #1a1c1e;
      --bg-secondary: #2c2f33;
      --bg-card: #2c2f33;
      --bg-side: #23272a;
      --text-primary: #edf2f7;
      --text-secondary: #cbd5e0;
      --accent-light: #2c5282;
      --accent-soft: #4a6a8a;
      --border: #3f444a;
      --shadow: rgba(0,0,0,0.3) 0 6px 18px;
      --sticky-bg: rgba(44, 47, 51, 0.95);
      --btn-hover: #40464b;
      --code-bg: #3a3f45;
    }

    /* ---------- layout ---------- */
    #app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 20px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .logo-area span {
      background: var(--accent-soft);
      padding: 6px 12px;
      border-radius: 40px;
      color: #1e1e2a;
      background: #b3d9e6;
    }
    body.dark .logo-area span {
      color: #0a0c0e;
      background: #7aa3b8;
    }

    .btn, button {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 40px;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow);
      transition: 0.15s;
    }
    .btn:hover, button:hover {
      background: var(--btn-hover);
    }

    /*  view container ÂàáÊç¢ */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    /* ---------- LIBRARY : song cards ---------- */
    .library-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }
    .search-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }
    #searchInput {
      padding: 12px 18px;
      border-radius: 40px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      width: 280px;
      font-size: 1rem;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }
    .tab-btn {
      background: transparent;
      border: none;
      box-shadow: none;
      border-radius: 0;
      padding: 8px 16px;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active {
      border-bottom-color: var(--accent-soft);
      font-weight: 600;
    }

    .song-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 24px;
    }
    .song-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.1s;
      display: flex;
      flex-direction: column;
    }
    .song-card:hover {
      transform: translateY(-4px);
    }
    .song-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .song-artist {
      color: var(--text-secondary);
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }
    .tag {
      background: var(--accent-light);
      padding: 4px 12px;
      border-radius: 30px;
      font-size: 0.75rem;
      font-weight: 500;
      color: #1e2b3a;
    }
    body.dark .tag {
      color: #edf2f7;
      background: #2d4a62;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    .fav-btn {
      background: none;
      border: none;
      font-size: 1.6rem;
      line-height: 1;
      box-shadow: none;
      padding: 0 4px;
      color: #f5b042;
    }
    .fav-btn:hover {
      background: none;
      transform: scale(1.1);
    }

    /* ---------- CHORD VIEWER (sticky chords) ---------- */
    .viewer-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 20px;
    }
    .sticky-panel {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--sticky-bg);
      backdrop-filter: blur(8px);
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 18px;
    }
    .chord-reference {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .chord-badge {
      background: var(--code-bg);
      padding: 6px 14px;
      border-radius: 40px;
      border-left: 5px solid var(--accent-soft);
    }
    .lyrics-box {
      font-size: var(--font-size, 18px);
      line-height: 2.2;
      padding-bottom: 40px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .chord-line {
      color: #0e6b8c;
      font-weight: 700;
      white-space: pre;
      font-size: 0.9em;
      margin-top: 12px;
    }
    body.dark .chord-line {
      color: #b3e4f5;
    }
    .lyric-line {
      white-space: pre;
      margin-bottom: 8px;
      font-size: 1em;
    }
    .hide-chords .chord-line {
      display: none;
    }
    .auto-scroll-active {
      scroll-behavior: smooth;
    }

    /* ---------- form & modals ---------- */
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1rem;
    }
    textarea {
      min-height: 200px;
      font-family: monospace;
    }

    /* ---------- responsive ---------- */
    @media (max-width: 720px) {
      .song-grid { grid-template-columns: 1fr; }
      .control-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ========== HEADER (Global) ========== -->
    <header>
      <div class="logo-area">
        <span>üéµ ChordViewer</span>
        <span style="background: var(--accent-soft); font-size: 0.8rem;">offline</span>
      </div>
      <div style="display: flex; gap: 12px;">
        <button id="themeToggle" class="btn">üåô Dark</button>
        <button id="exportBtn" class="btn">üì§ Export</button>
        <button id="importBtn" class="btn">üì• Import</button>
      </div>
    </header>

    <!-- ========== MAIN VIEWS (SPA) ========== -->
    <main id="main-content">
      <!-- LIBRARY VIEW -->
      <div id="libraryView" class="view active">
        <div class="library-header">
          <h1>üìö ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
          <div>
            <button id="addSongBtn" class="btn" style="background: var(--accent-soft);">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á</button>
          </div>
        </div>
        <!-- search & filter row -->
        <div class="search-filter">
          <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á / ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô / ‡πÅ‡∏ó‡πá‡∏Å" autocomplete="off">
          <select id="artistFilterSelect" style="width: 180px;">
            <option value="">üé§ ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          </select>
          <select id="tagFilterSelect" style="width: 160px;">
            <option value="">üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          </select>
          <button id="favoritesOnlyBtn" class="btn">‚≠ê ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏õ‡∏£‡∏î</button>
        </div>

        <!-- Tabs: All / Artists / Favorites -->
        <div class="tabs">
          <button id="tabAll" class="tab-btn active">üéµ ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button id="tabArtistGroup" class="tab-btn">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô</button>
          <button id="tabFav" class="tab-btn">‚≠ê ‡πÄ‡∏û‡∏•‡∏á‡πÇ‡∏õ‡∏£‡∏î</button>
        </div>

        <!-- Song container -->
        <div id="songContainer"></div>
      </div>

      <!-- CHORD VIEWER PAGE -->
      <div id="chordViewerView" class="view">
        <div class="viewer-header">
          <button id="backToLibraryBtn" class="btn">‚óÄ ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏á</button>
          <h2 id="viewerSongTitle"></h2>
          <div style="display: flex; gap: 8px; margin-left: auto;">
            <button id="editFromViewerBtn" class="btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button id="deleteFromViewerBtn" class="btn">üóëÔ∏è ‡∏•‡∏ö</button>
            <button id="favViewerBtn" class="fav-btn" style="font-size: 2rem;">‚òÜ</button>
          </div>
        </div>

        <!-- STICKY control panel + chords -->
        <div class="sticky-panel">
          <div class="control-row">
            <div style="display: flex; gap: 8px; align-items: center;">
              <span>‡∏Ñ‡∏µ‡∏¢‡πå: <strong id="currentKeyDisplay">C</strong></span>
              <button id="transposeDownBtn" class="btn">‚ô≠ -</button>
              <button id="transposeUpBtn" class="btn">‚ôØ +</button>
              <button id="resetKeyBtn" class="btn">‚Ü∫ ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°</button>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="fontDecBtn" class="btn">A-</button>
              <button id="fontIncBtn" class="btn">A+</button>
              <button id="toggleChordsBtn" class="btn">üé∏ ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏î</button>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="autoScrollPlayBtn" class="btn">‚ñ∂ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</button>
              <button id="autoScrollStopBtn" class="btn">‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
              <span>‚ö°</span>
              <input type="range" id="scrollSpeedSlider" min="1" max="5" step="0.5" value="2" style="width:100px;">
              <span id="speedLabel">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
            </div>
          </div>
          <!-- ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (sticky) -->
          <div id="chordReferenceSticky" class="chord-reference"></div>
        </div>

        <!-- Lyrics display area -->
        <div id="lyricsDisplay" class="lyrics-box" style="font-size: 18px;"></div>
      </div>

      <!-- ADD / EDIT FORM VIEW -->
      <div id="formView" class="view">
        <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 32px;">
          <button id="cancelFormBtn" class="btn">‚óÄ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <h2 id="formTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
        </div>
        <form id="songForm">
          <input type="hidden" id="songId" value="">
          <div class="form-group">
            <label>üé§ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á *</label>
            <input type="text" id="titleInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required>
          </div>
          <div class="form-group">
            <label>üë§ ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô *</label>
            <input type="text" id="artistInput" placeholder="‡∏ô‡∏ô‡∏ó‡πå ‡∏ò‡∏ô‡∏ô‡∏ó‡πå" required>
          </div>
          <div class="form-group">
            <label>üéº ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label>
            <select id="keySelect" required>
              <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option>
              <option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option>
              <option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
            </select>
          </div>
          <div class="form-group">
            <label>üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤) </label>
            <input type="text" id="tagsInput" placeholder="Pop, Ballad, ‡∏™‡∏ï‡∏£‡∏¥‡∏á">
          </div>
          <div class="form-group">
            <label>üìÑ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á + ‡∏Ñ‡∏≠‡∏£‡πå‡∏î (‡πÉ‡∏ä‡πâ [‡∏Ñ‡∏≠‡∏£‡πå‡∏î] ‡∏ß‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥)</label>
            <textarea id="lyricsInput" placeholder="[C]‡∏Ç‡∏≠[C]‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å[C]‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." required></textarea>
            <small style="color: var(--text-secondary);">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: [C]‡∏Ç‡∏≠[C]‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å[C]‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</small>
          </div>
          <button type="submit" id="saveSongBtn" class="btn" style="background: var(--accent-soft);">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏•‡∏á</button>
        </form>
      </div>
    </main>

    <!-- hidden import file input -->
    <input type="file" id="importFileInput" accept=".json,application/json" style="display: none;">
  </div>

  <script>
    (function(){
      "use strict";

      // ---------- ******** DATA STORE ******** ----------
      const STORAGE_KEY = 'chordViewerSongs';
      const FAV_KEY = 'chordViewerFavs';
      const SAMPLE_SONGS = [
        { id: '1', title: '‡∏Ç‡∏≠‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', artist: '‡∏ô‡∏ô‡∏ó‡πå ‡∏ò‡∏ô‡∏ô‡∏ó‡πå', tags: ['Pop', 'Acoustic'], key: 'C', lyrics: '[C]‡∏Ç‡∏≠[C]‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å[C]‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£\n[C]‡πÑ‡∏î‡πâ[C]‡πÑ‡∏´‡∏°‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏ô[C]‡∏î‡∏µ\n[G]‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏∞‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏ò‡∏≠[Am]‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡πÜ ‡∏ó‡∏∏‡∏Å[F]‡∏ß‡∏±‡∏ô' },
        { id: '2', title: '‡∏£‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏û‡∏ö', artist: 'Klein', tags: ['Pop'], key: 'G', lyrics: '[G]‡∏£‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏û‡∏ö[D]‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢[Em]‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á[Bm] \n[C]‡πÅ‡∏ï‡πà‡∏û‡∏≠‡πÄ‡∏à‡∏≠‡πÄ‡∏ò‡∏≠[G]‡∏â‡∏±‡∏ô‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à[Am] [D]' },
        { id: '3', title: '‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', artist: 'Three Man Down', tags: ['Rock', 'Sad'], key: 'A', lyrics: '[A]‡∏´‡∏≤‡∏Å‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà[E]‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç\n[F#m]‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö[D]‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏ô‡∏µ‡πâ[A]‡πÑ‡∏ß‡πâ' },
        { id: '4', title: '‡∏ñ‡πâ‡∏≤‡πÄ‡∏ò‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', artist: 'D Gerrard', tags: ['Ballad'], key: 'E', lyrics: '[E]‡∏ñ‡πâ‡∏≤‡πÄ‡∏ò‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å[B] ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏â‡∏±‡∏ô‡∏Å‡∏±‡∏ö[C#m]‡πÉ‡∏Ñ‡∏£\n[A]‡πÄ‡∏ò‡∏≠‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏â‡∏±‡∏ô‡πÑ‡∏´‡∏°[E]' },
        { id: '5', title: 'Melbourne', artist: 'Morvasu', tags: ['Indie'], key: 'F', lyrics: '[F]Melbourne [C]city [Dm]slow... [Bb]' },
        { id: '6', title: 'Lovely', artist: 'Billie Eilish', tags: ['Pop'], key: 'C#', lyrics: '[C#]Thought I found a [G#]way' }
      ];

      // ---------- GLOBAL STATE ----------
      let songs = [];
      let favorites = new Set();      // ‡πÄ‡∏Å‡πá‡∏ö id string
      let currentView = 'library';   // library, viewer, form
      let currentSongId = null;
      let transposeOffset = 0;
      let originalKey = 'C';
      let isAutoScrolling = false;
      let autoScrollInterval = null;
      let scrollSpeed = 2;          // 1-5
      let fontSize = 18;           // px
      let hideChordsFlag = false;
      let darkMode = false;
      let currentFilter = { search: '', artist: '', tag: '', onlyFav: false };
      let activeTab = 'all';       // all, artist, fav

      // ---------- UTILS / CHORD TRANSPOSE ----------
      const chordRoots = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      function transposeChord(chord, semitones) {
        if (!chord) return chord;
        const match = chord.match(/^([A-G]#?)(.*)$/);
        if (!match) return chord;
        let root = match[1];
        let suffix = match[2];
        let idx = chordRoots.indexOf(root);
        if (idx === -1) return chord;
        let newIdx = (idx + semitones + 12) % 12;
        return chordRoots[newIdx] + suffix;
      }

      function transposeAllChords(lyrics, offset) {
        if (offset === 0) return lyrics;
        return lyrics.replace(/\[([^\]]+)\]/g, (match, chord) => {
          return '[' + transposeChord(chord, offset) + ']';
        });
      }

      // ---------- LOCALSTORAGE ----------
      function loadSongs() {
        let stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          try { songs = JSON.parse(stored); } catch(e){ songs = []; }
        }
        if (!songs || songs.length === 0) {
          songs = SAMPLE_SONGS.map(s => ({ ...s })); // clone
        }
        // load favorites
        let favStored = localStorage.getItem(FAV_KEY);
        if (favStored) {
          try { favorites = new Set(JSON.parse(favStored)); } catch(e){ favorites = new Set(); }
        }
      }
      function saveSongs() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(songs));
      }
      function saveFavorites() {
        localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(favorites)));
      }

      // ---------- RENDER LIBRARY ----------
      function renderLibrary() {
        let container = document.getElementById('songContainer');
        if (!container) return;
        let filtered = songs.filter(song => {
          if (currentFilter.onlyFav && !favorites.has(song.id)) return false;
          if (currentFilter.artist && song.artist !== currentFilter.artist) return false;
          if (currentFilter.tag) {
            if (!song.tags || !song.tags.includes(currentFilter.tag)) return false;
          }
          if (currentFilter.search) {
            let term = currentFilter.search.toLowerCase();
            return song.title.toLowerCase().includes(term) || song.artist.toLowerCase().includes(term) || (song.tags && song.tags.some(t => t.toLowerCase().includes(term)));
          }
          return true;
        });

        // active tab grouping
        if (activeTab === 'fav') {
          filtered = filtered.filter(s => favorites.has(s.id));
        }

        let html = '';
        if (activeTab === 'artistGroup') {
          let artistMap = new Map();
          filtered.forEach(s => { let a = s.artist; if(!artistMap.has(a)) artistMap.set(a, []); artistMap.get(a).push(s); });
          for (let [artist, songList] of artistMap) {
            html += `<h3 style="margin: 20px 0 8px;">üé§ ${artist}</h3><div class="song-grid">`;
            songList.forEach(s => html += renderCard(s));
            html += `</div>`;
          }
        } else {
          html = `<div class="song-grid">${filtered.map(s => renderCard(s)).join('')}</div>`;
        }
        container.innerHTML = html || '<p style="padding: 40px; text-align: center;">‚ú® ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</p>';

        // populate filter dropdowns
        let artistSet = new Set(songs.map(s => s.artist));
        let artistSelect = document.getElementById('artistFilterSelect');
        artistSelect.innerHTML = '<option value="">üé§ ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + Array.from(artistSet).sort().map(a => `<option value="${a}">${a}</option>`).join('');
        artistSelect.value = currentFilter.artist || '';

        let tagSet = new Set();
        songs.forEach(s => s.tags && s.tags.forEach(t => tagSet.add(t)));
        let tagSelect = document.getElementById('tagFilterSelect');
        tagSelect.innerHTML = '<option value="">üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + Array.from(tagSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');
        tagSelect.value = currentFilter.tag || '';
      }

      function renderCard(song) {
        let isFav = favorites.has(song.id);
        return `<div class="song-card" data-id="${song.id}">
          <div class="song-title">${song.title}</div>
          <div class="song-artist">${song.artist} ¬∑ ‡∏Ñ‡∏µ‡∏¢‡πå ${song.key}</div>
          <div class="tags">${(song.tags || []).map(t => `<span class="tag">#${t}</span>`).join('')}</div>
          <div class="card-footer">
            <button class="btn select-song" data-id="${song.id}">üé∏ ‡∏î‡∏π‡∏Ñ‡∏≠‡∏£‡πå‡∏î</button>
            <button class="fav-btn" data-id="${song.id}">${isFav ? '‚òÖ' : '‚òÜ'}</button>
          </div>
        </div>`;
      }

      // ---------- CHORD VIEWER ----------
      function renderChordViewer() {
        let song = songs.find(s => s.id === currentSongId);
        if (!song) { switchView('library'); return; }
        document.getElementById('viewerSongTitle').innerText = `${song.title} - ${song.artist}`;
        originalKey = song.key;
        document.getElementById('currentKeyDisplay').innerText = transposeKey(originalKey, transposeOffset);
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà transpose ‡πÅ‡∏•‡πâ‡∏ß
        let transposedLyrics = transposeAllChords(song.lyrics, transposeOffset);
        let allChords = new Set();
        transposedLyrics.match(/\[([^\]]+)\]/g)?.forEach(c => { let m = c.match(/\[([^\]]+)\]/); if(m) allChords.add(m[1]); });
        let chordRefDiv = document.getElementById('chordReferenceSticky');
        chordRefDiv.innerHTML = Array.from(allChords).map(c => `<span class="chord-badge">${c}</span>`).join('');

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏ö‡∏ö 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ö‡∏ô, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏á)
        let lines = transposedLyrics.split('\n');
        let html = '';
        lines.forEach(line => {
          let chordLine = '', lyricLine = line;
          let parts = line.split(/(\[[^\]]+\])/);
          let chordSpans = [];
          let lyricSpans = [];
          let currentIdx = 0;
          parts.forEach(p => {
            if (p.startsWith('[') && p.endsWith(']')) {
              chordSpans.push(`<span style="margin-left: ${currentIdx}ch;">${p}</span>`);
            } else {
              lyricSpans.push(p);
              currentIdx += p.length;
            }
          });
          html += `<div class="chord-line">${chordSpans.join(' ')}</div>`;
          html += `<div class="lyric-line">${lyricSpans.join('')}</div>`;
        });
        let lyricsDiv = document.getElementById('lyricsDisplay');
        lyricsDiv.innerHTML = html;
        lyricsDiv.style.fontSize = fontSize + 'px';
        lyricsDiv.classList.toggle('hide-chords', hideChordsFlag);
        // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏î
        document.getElementById('favViewerBtn').innerText = favorites.has(song.id) ? '‚òÖ' : '‚òÜ';
      }

      function transposeKey(key, offset) {
        let idx = chordRoots.indexOf(key);
        if (idx === -1) return key;
        return chordRoots[(idx + offset + 12) % 12];
      }

      // ---------- VIEW SWITCHER ----------
      function switchView(viewName, songId = null) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        if (viewName === 'library') {
          document.getElementById('libraryView').classList.add('active');
          currentView = 'library';
          renderLibrary();
        } else if (viewName === 'viewer') {
          if (!songId) return;
          currentSongId = songId;
          transposeOffset = 0;
          hideChordsFlag = false;
          document.getElementById('toggleChordsBtn').innerText = 'üé∏ ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏î';
          document.getElementById('chordViewerView').classList.add('active');
          currentView = 'viewer';
          renderChordViewer();
        } else if (viewName === 'form') {
          document.getElementById('formView').classList.add('active');
          currentView = 'form';
        }
      }

      // ---------- FORM : add / edit ----------
      function openAddForm() {
        document.getElementById('formTitle').innerText = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('songForm').reset();
        document.getElementById('songId').value = '';
        switchView('form');
      }
      function openEditForm(songId) {
        let song = songs.find(s => s.id === songId);
        if (!song) return;
        document.getElementById('formTitle').innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏•‡∏á';
        document.getElementById('songId').value = song.id;
        document.getElementById('titleInput').value = song.title;
        document.getElementById('artistInput').value = song.artist;
        document.getElementById('keySelect').value = song.key;
        document.getElementById('tagsInput').value = (song.tags || []).join(', ');
        document.getElementById('lyricsInput').value = song.lyrics;
        switchView('form');
      }

      // ---------- AUTO SCROLL ----------
      function startAutoScroll() {
        if (isAutoScrolling) stopAutoScroll();
        let lyricsBox = document.getElementById('lyricsDisplay');
        isAutoScrolling = true;
        let speedFactor = {1: 10, 1.5: 15, 2: 22, 2.5: 30, 3: 38, 3.5: 46, 4: 55, 4.5: 65, 5: 75};
        let intervalTime = 200; // ms
        autoScrollInterval = setInterval(() => {
          if (!lyricsBox) return;
          lyricsBox.scrollBy({ top: speedFactor[scrollSpeed] || 22, behavior: 'smooth' });
        }, 180);
      }
      function stopAutoScroll() {
        clearInterval(autoScrollInterval);
        isAutoScrolling = false;
      }

      // ---------- INITIAL EVENT LISTENERS ----------
      function bindEvents() {
        // theme
        document.getElementById('themeToggle').addEventListener('click', function() {
          document.body.classList.toggle('dark');
          darkMode = !darkMode;
          this.innerText = darkMode ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });

        // export/import
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('importFileInput').click());
        document.getElementById('importFileInput').addEventListener('change', importData);

        // library events (delegation)
        document.getElementById('songContainer').addEventListener('click', (e) => {
          let card = e.target.closest('.song-card');
          if (e.target.classList.contains('select-song') || e.target.closest('.select-song')) {
            let id = e.target.dataset.id || e.target.closest('.select-song').dataset.id;
            switchView('viewer', id);
          }
          if (e.target.classList.contains('fav-btn')) {
            let id = e.target.dataset.id;
            if (favorites.has(id)) favorites.delete(id); else favorites.add(id);
            saveFavorites();
            renderLibrary();
          }
        });

        // search / filter
        document.getElementById('searchInput').addEventListener('input', (e) => { currentFilter.search = e.target.value; renderLibrary(); });
        document.getElementById('artistFilterSelect').addEventListener('change', (e) => { currentFilter.artist = e.target.value; renderLibrary(); });
        document.getElementById('tagFilterSelect').addEventListener('change', (e) => { currentFilter.tag = e.target.value; renderLibrary(); });
        document.getElementById('favoritesOnlyBtn').addEventListener('click', ()=>{ currentFilter.onlyFav = !currentFilter.onlyFav; renderLibrary(); });
        document.getElementById('tabAll').addEventListener('click', ()=>{ activeTab='all'; renderLibrary(); });
        document.getElementById('tabArtistGroup').addEventListener('click', ()=>{ activeTab='artistGroup'; renderLibrary(); });
        document.getElementById('tabFav').addEventListener('click', ()=>{ activeTab='fav'; renderLibrary(); });

        // add song btn
        document.getElementById('addSongBtn').addEventListener('click', openAddForm);
        document.getElementById('cancelFormBtn').addEventListener('click', ()=> switchView('library'));
        // form save
        document.getElementById('songForm').addEventListener('submit', (e) => {
          e.preventDefault();
          let id = document.getElementById('songId').value;
          let newSong = {
            id: id || Date.now().toString(),
            title: document.getElementById('titleInput').value,
            artist: document.getElementById('artistInput').value,
            key: document.getElementById('keySelect').value,
            tags: document.getElementById('tagsInput').value.split(',').map(t=>t.trim()).filter(t=>t),
            lyrics: document.getElementById('lyricsInput').value
          };
          if (id) {
            let index = songs.findIndex(s => s.id === id);
            if (index !== -1) songs[index] = newSong;
          } else {
            songs.push(newSong);
          }
          saveSongs();
          switchView('library');
        });

        // back to library
        document.getElementById('backToLibraryBtn').addEventListener('click', ()=> switchView('library'));
        // viewer controls
        document.getElementById('transposeUpBtn').addEventListener('click', ()=>{ transposeOffset++; renderChordViewer(); });
        document.getElementById('transposeDownBtn').addEventListener('click', ()=>{ transposeOffset--; renderChordViewer(); });
        document.getElementById('resetKeyBtn').addEventListener('click', ()=>{ transposeOffset=0; renderChordViewer(); });
        document.getElementById('fontIncBtn').addEventListener('click', ()=>{ fontSize = Math.min(32, fontSize+2); document.getElementById('lyricsDisplay').style.fontSize = fontSize+'px'; });
        document.getElementById('fontDecBtn').addEventListener('click', ()=>{ fontSize = Math.max(12, fontSize-2); document.getElementById('lyricsDisplay').style.fontSize = fontSize+'px'; });
        document.getElementById('toggleChordsBtn').addEventListener('click', function(){
          hideChordsFlag = !hideChordsFlag;
          document.getElementById('lyricsDisplay').classList.toggle('hide-chords', hideChordsFlag);
          this.innerText = hideChordsFlag ? 'üé∏ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î' : 'üé∏ ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏î';
        });
        // auto scroll
        document.getElementById('autoScrollPlayBtn').addEventListener('click', startAutoScroll);
        document.getElementById('autoScrollStopBtn').addEventListener('click', stopAutoScroll);
        document.getElementById('scrollSpeedSlider').addEventListener('input', (e)=>{ scrollSpeed = parseFloat(e.target.value); document.getElementById('speedLabel').innerText = ['‡∏ä‡πâ‡∏≤','','‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á','','‡πÄ‡∏£‡πá‡∏ß'][Math.round(scrollSpeed)-1] || '‡∏Å‡∏•‡∏≤‡∏á'; });
        // fav in viewer
        document.getElementById('favViewerBtn').addEventListener('click', function(){
          if (favorites.has(currentSongId)) favorites.delete(currentSongId); else favorites.add(currentSongId);
          saveFavorites();
          this.innerText = favorites.has(currentSongId) ? '‚òÖ' : '‚òÜ';
        });
        // edit from viewer
        document.getElementById('editFromViewerBtn').addEventListener('click', ()=> { if(currentSongId) openEditForm(currentSongId); });
        document.getElementById('deleteFromViewerBtn').addEventListener('click', ()=> {
          if(confirm('‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á?')) { songs = songs.filter(s => s.id !== currentSongId); favorites.delete(currentSongId); saveSongs(); saveFavorites(); switchView('library'); }
        });
      }

      // ---------- EXPORT / IMPORT ----------
      function exportData() {
        let data = { songs, favorites: Array.from(favorites), version: '1.0' };
        let blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = `my-songs-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      }
      function importData(e) {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = (ev) => {
          try {
            let data = JSON.parse(ev.target.result);
            if (data.songs) {
              if (confirm('Replace existing songs? (OK = ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà, Cancel = ‡∏ú‡∏™‡∏≤‡∏ô)')) {
                songs = data.songs;
              } else {
                songs = songs.concat(data.songs);
              }
              if (data.favorites) favorites = new Set(data.favorites);
              saveSongs(); saveFavorites();
              renderLibrary();
            }
          } catch (ex) { alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
          document.getElementById('importFileInput').value = '';
        };
        reader.readAsText(file);
      }

      // ---------- BOOTSTRAP ----------
      loadSongs();
      bindEvents();
      renderLibrary();
    })();
  </script>
</body>
</html>