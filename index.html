<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Viewer - ‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡∏á‡πà‡∏≤‡∏¢‡πÜ</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #333333;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --accent-color: #e9ecef;
            --chord-color: #007bff;
            --border-color: #dee2e6;
            --sticky-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --primary-color: #4dabf7;
            --secondary-color: #adb5bd;
            --accent-color: #3d3d3d;
            --chord-color: #4dabf7;
            --border-color: #444444;
            --sticky-bg: rgba(45, 45, 45, 0.95);
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; line-height: 1.6; }
        
        /* Layout */
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        
        /* Components */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; background: var(--accent-color); color: var(--text-color); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .search-box { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid var(--border-color); border-radius: 8px; background: var(--container-bg); color: var(--text-color); }

        /* Song List */
        .song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .song-card { background: var(--container-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); cursor: pointer; position: relative; }
        .song-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .fav-star { position: absolute; top: 10px; right: 10px; font-size: 1.2rem; }

        /* Viewer Mode */
        #viewer-screen { display: none; }
        .controls-sticky { position: sticky; top: 0; background: var(--sticky-bg); z-index: 100; padding: 10px 0; border-bottom: 1px solid var(--border-color); backdrop-filter: blur(5px); }
        .control-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
        
        .lyrics-area { white-space: pre-wrap; margin-top: 30px; font-family: 'Courier New', Courier, monospace; overflow-x: auto; }
        .line-wrapper { margin-bottom: 1.5em; display: flex; flex-direction: column; }
        .chord-line { color: var(--chord-color); font-weight: bold; min-height: 1.2em; display: flex; }
        .chord-item { position: absolute; }
        .lyric-line { min-height: 1.2em; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: var(--container-bg); margin: 5% auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 12px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); }

        .hidden { display: none !important; }
        
        @media (max-width: 600px) {
            .control-group { justify-content: center; }
        }
    </style>
</head>
<body data-theme="light">

<div class="container">
    <div id="home-screen">
        <header>
            <h1>üé∏ Chord Viewer</h1>
            <div>
                <button class="btn" onclick="toggleTheme()" id="theme-btn">üåô</button>
                <button class="btn btn-primary" onclick="showModal('song-modal')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á</button>
            </div>
        </header>

        <input type="text" class="search-box" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ó‡πá‡∏Å..." oninput="renderLibrary()">

        <div class="control-group">
            <button class="btn" onclick="filterType = 'all'; renderLibrary()">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn" onclick="filterType = 'fav'; renderLibrary()">‚≠ê ‡πÄ‡∏û‡∏•‡∏á‡πÇ‡∏õ‡∏£‡∏î</button>
            <button class="btn" onclick="exportData()">Export JSON</button>
            <button class="btn" onclick="document.getElementById('import-file').click()">Import</button>
            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
        </div>

        <div class="song-grid" id="song-library"></div>
    </div>

    <div id="viewer-screen">
        <div class="controls-sticky">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn" onclick="closeViewer()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
                <h2 id="view-title" style="margin:0"></h2>
                <button class="btn" id="view-fav-btn">‚òÜ</button>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--border-color); margin:10px 0;">
            
            <div class="control-group">
                <span>Transpose:</span>
                <button class="btn" onclick="transpose(-1)">-</button>
                <b id="current-key-display">C</b>
                <button class="btn" onclick="transpose(1)">+</button>
                
                <span style="margin-left:15px">Size:</span>
                <button class="btn" onclick="changeFontSize(-2)">A-</button>
                <button class="btn" onclick="changeFontSize(2)">A+</button>
                
                <button class="btn" onclick="toggleChords()" id="toggle-chord-btn">‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏î</button>
            </div>

            <div class="control-group">
                <span>Scroll:</span>
                <button class="btn" id="scroll-btn" onclick="toggleScroll()">‚ñ∂ Play</button>
                <input type="range" id="scroll-speed" min="1" max="10" value="2" style="width:100px">
            </div>
            <div id="chord-summary" style="font-size: 0.9rem; color: var(--secondary-color);"></div>
        </div>

        <div id="lyrics-display" class="lyrics-area"></div>
    </div>
</div>

<div id="song-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <input type="text" id="form-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)">
        <input type="text" id="form-artist" placeholder="‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô">
        <input type="text" id="form-key" placeholder="‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô C, G, Am)">
        <input type="text" id="form-tags" placeholder="‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô Pop, Rock)">
        <textarea id="form-lyrics" rows="10" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏î ‡πÄ‡∏ä‡πà‡∏ô: [C]‡∏Ç‡∏≠‡πÉ‡∏à‡πÄ‡∏ò‡∏≠[G]‡πÅ‡∏•‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="saveSong()" style="flex:1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn" onclick="hideModal('song-modal')" style="flex:1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <button class="btn btn-danger" id="delete-btn" style="width:100%; margin-top:10px; display:none;">‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ</button>
    </div>
</div>

<script>
    // --- Data Management ---
    const defaultSongs = [
        {
            id: 1, title: "‡πÄ‡∏û‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ)", artist: "Slot Machine", 
            key: "G", tags: ["Rock"], fav: false,
            lyrics: "[G]‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤[D]‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ß‡∏ô‡∏≠‡∏¢‡∏π‡πà[Em]‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°\n[C]‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞[G]‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏õ‡πÑ‡∏î‡πâ[D]‡πÑ‡∏Å‡∏•"
        },
        {
            id: 2, title: "‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢", artist: "BNK48", 
            key: "E", tags: ["Pop"], fav: true,
            lyrics: "[E]‡πÅ‡∏≠‡∏ö‡∏°‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞‡∏à‡πä‡∏∞ [G#m]‡πÅ‡∏ï‡πà‡πÄ‡∏ò‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ö‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢\n[A]‡πÅ‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡∏î‡πÜ [B]‡πÅ‡∏ï‡πà‡∏î‡∏π‡πÄ‡∏ò‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏¢‡πÄ‡∏°‡∏¢"
        }
    ];

    let songs = JSON.parse(localStorage.getItem('chord_db')) || defaultSongs;
    let currentSong = null;
    let currentKeyOffset = 0;
    let fontSize = 16;
    let filterType = 'all';
    let isScrolling = false;
    let scrollInterval = null;
    let showChords = true;

    const keys = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    // --- Core Logic ---
    function saveToStorage() {
        localStorage.setItem('chord_db', JSON.stringify(songs));
    }

    function renderLibrary() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const grid = document.getElementById('song-library');
        grid.innerHTML = '';

        const filtered = songs.filter(s => {
            const matchSearch = s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query);
            const matchFilter = filterType === 'fav' ? s.fav : true;
            return matchSearch && matchFilter;
        });

        filtered.forEach(song => {
            const card = document.createElement('div');
            card.className = 'song-card';
            card.innerHTML = `
                <div class="fav-star">${song.fav ? '‚≠ê' : '‚òÜ'}</div>
                <div style="font-weight:bold">${song.title}</div>
                <div style="font-size:0.8rem; color:var(--secondary-color)">${song.artist}</div>
                <div style="margin-top:5px; font-size:0.7rem;">
                    ${song.tags.map(t => `<span style="background:var(--accent-color); padding:2px 5px; border-radius:4px; margin-right:3px;">${t}</span>`).join('')}
                </div>
            `;
            card.onclick = () => openViewer(song.id);
            grid.appendChild(card);
        });
    }

    // --- Viewer Logic ---
    function openViewer(id) {
        currentSong = songs.find(s => s.id === id);
        currentKeyOffset = 0;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('viewer-screen').style.display = 'block';
        document.getElementById('view-title').innerText = currentSong.title;
        document.getElementById('view-fav-btn').innerText = currentSong.fav ? '‚≠ê' : '‚òÜ';
        document.getElementById('view-fav-btn').onclick = (e) => {
            currentSong.fav = !currentSong.fav;
            e.target.innerText = currentSong.fav ? '‚≠ê' : '‚òÜ';
            saveToStorage();
        };
        updateDisplay();
    }

    function closeViewer() {
        stopScroll();
        document.getElementById('home-screen').style.display = 'block';
        document.getElementById('viewer-screen').style.display = 'none';
        renderLibrary();
    }

    function transpose(dir) {
        currentKeyOffset += dir;
        updateDisplay();
    }

    function transposeChord(chord, offset) {
        return chord.replace(/[A-G](?![a-z])#?|b?/g, (match) => {
            if (!match) return "";
            let idx = keys.indexOf(match.replace('b', ''));
            if (match.includes('b')) idx--; 
            if (idx === -1) return match;
            let newIdx = (idx + offset) % 12;
            while (newIdx < 0) newIdx += 12;
            return keys[newIdx];
        });
    }

    function updateDisplay() {
        const display = document.getElementById('lyrics-display');
        const keyDisplay = document.getElementById('current-key-display');
        const chordSummary = document.getElementById('chord-summary');
        
        keyDisplay.innerText = transposeChord(currentSong.key, currentKeyOffset);
        display.style.fontSize = fontSize + 'px';

        const lines = currentSong.lyrics.split('\n');
        let html = '';
        let usedChords = new Set();

        lines.forEach(line => {
            let chordLine = "";
            let lyricLine = "";
            let lastIdx = 0;
            const regex = /\[(.*?)\]/g;
            let match;

            // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô
            let tempLine = line;
            let chordsInLine = [];
            while ((match = regex.exec(line)) !== null) {
                const chord = transposeChord(match[1], currentKeyOffset);
                usedChords.add(chord);
                chordsInLine.push({ chord: chord, pos: match.index - (chordsInLine.length * (match[1].length + 2)) });
                tempLine = tempLine.replace(match[0], "");
            }

            if (showChords) {
                let cLine = " ".repeat(100).split(""); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ß‡πà‡∏≤‡∏á
                chordsInLine.forEach(c => {
                    for(let i=0; i<c.chord.length; i++) cLine[c.pos + i] = c.chord[i];
                });
                chordLine = `<div class="chord-line">${cLine.join('').trimEnd()}</div>`;
            }

            html += `<div class="line-wrapper">${chordLine}<div class="lyric-line">${tempLine || " "}</div></div>`;
        });

        display.innerHTML = html;
        chordSummary.innerText = "Chords: " + Array.from(usedChords).join(", ");
    }

    // --- Features ---
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('theme-btn');
        if (body.getAttribute('data-theme') === 'light') {
            body.setAttribute('data-theme', 'dark');
            btn.innerText = 'üåû';
        } else {
            body.setAttribute('data-theme', 'light');
            btn.innerText = 'üåô';
        }
    }

    function toggleChords() {
        showChords = !showChords;
        document.getElementById('toggle-chord-btn').innerText = showChords ? "‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏î" : "‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î";
        updateDisplay();
    }

    function changeFontSize(delta) {
        fontSize += delta;
        updateDisplay();
    }

    function toggleScroll() {
        if (isScrolling) stopScroll();
        else startScroll();
    }

    function startScroll() {
        isScrolling = true;
        document.getElementById('scroll-btn').innerText = "‚è∏ Pause";
        const speed = document.getElementById('scroll-speed').value;
        scrollInterval = setInterval(() => {
            window.scrollBy(0, 1);
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) stopScroll();
        }, 100 / speed);
    }

    function stopScroll() {
        isScrolling = false;
        document.getElementById('scroll-btn').innerText = "‚ñ∂ Play";
        clearInterval(scrollInterval);
    }

    // --- Modal & Form ---
    function showModal(id) {
        document.getElementById(id).style.display = 'block';
    }

    function hideModal(id) {
        document.getElementById(id).style.display = 'none';
        // Reset form
        document.getElementById('form-title').value = '';
        document.getElementById('form-artist').value = '';
        document.getElementById('form-key').value = '';
        document.getElementById('form-tags').value = '';
        document.getElementById('form-lyrics').value = '';
    }

    function saveSong() {
        const title = document.getElementById('form-title').value;
        const artist = document.getElementById('form-artist').value;
        if(!title || !artist) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô");

        const newSong = {
            id: Date.now(),
            title: title,
            artist: artist,
            key: document.getElementById('form-key').value || "C",
            tags: document.getElementById('form-tags').value.split(',').map(t => t.trim()),
            fav: false,
            lyrics: document.getElementById('form-lyrics').value
        };

        songs.push(newSong);
        saveToStorage();
        hideModal('song-modal');
        renderLibrary();
    }

    // --- Data Transfer ---
    function exportData() {
        const dataStr = JSON.stringify(songs, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `my-songs-backup-${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    songs = imported;
                    saveToStorage();
                    renderLibrary();
                }
            } catch (err) { alert("‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        };
        reader.readAsText(file);
    }

    // Hotkeys
    window.onkeydown = (e) => {
        if (document.getElementById('viewer-screen').style.display === 'block') {
            if (e.code === 'Space') { e.preventDefault(); toggleScroll(); }
            if (e.key === '+') transpose(1);
            if (e.key === '-') transpose(-1);
            if (e.key === 'Escape') closeViewer();
        }
    };

    // Initial Load
    renderLibrary();
</script>

</body>
</html>
